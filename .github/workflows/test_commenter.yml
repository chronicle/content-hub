name: Comment on Test Failure

on:
  workflow_run:
    workflows: ["Test Integrations"]
    types:
    - completed

permissions:
  pull-requests: write

jobs:
  post_comment:
    runs-on: ubuntu-latest

    if: github.event.workflow_run.conclusion == 'failure'

    steps:
    - name: Download test report
      uses: actions/download-artifact@v4
      with:
        name: test-report-md
        run-id: ${{ github.event.workflow_run.id }}

    - name: Comment on PR with Collapsible Report
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          // Find the pull request associated with the commit SHA
          const response = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${github.event.workflow_run.head_repository.owner.login}:${github.event.workflow_run.head_branch}`
          });
          const pr = response.data[0];
          if (!pr) {
            console.log('No matching PR found for this workflow run.');
            return;
          }
          
          const reportPath = './test_report.md';
          if (!fs.existsSync(reportPath)) {
            console.log('Test report file not found.');
            return;
          }
          const reportBody = fs.readFileSync(reportPath, 'utf8');
          
          const finalComment = `‚ùå **Integration Tests Failed**
          <details>
          <summary>Click to view the full test report</summary>
          
          ---
          
          ${reportBody}
          
          </details>`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            body: finalComment
          });
