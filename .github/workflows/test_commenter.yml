name: Post Test Failure Comment

on:
  workflow_run:
    workflows: ["Test Integrations"]
    types:
    - completed

permissions:
  pull-requests: write

jobs:
  comment_on_pr:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'failure'

    steps:
    - name: Download Test Report Artifact
      uses: actions/download-artifact@v4
      with:
        name: test-report-md
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Comment on PR with Collapsible Report
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          // Safely get the pull request number
          const pull_requests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
          const prNumber = pull_requests.length > 0 ? pull_requests[0].number : null;
          
          if (!prNumber) {
            console.log('Could not find an associated pull request. Skipping comment.');
            return;
          }
          
          const reportPath = 'test_report.md'; // It's downloaded to the workspace root
          if (!fs.existsSync(reportPath)) {
            console.log(`Report file not found at ${reportPath}. Posting a fallback comment.`);
            const fallbackComment = `❌ **Integration Tests Failed**\n\nThe test report artifact could not be found. Please check the logs of the 'Test integrations' workflow run for details.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: fallbackComment
            });
            return;
          }
          
          const reportBody = fs.readFileSync(reportPath, 'utf8');
          
          const finalComment = `❌ **Integration Tests Failed**
          <details>
          <summary>Click to view the full test report</summary>
          ---
          ${reportBody}
          </details>`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: finalComment
          });
