{"Name":"Get ASN Reputation","Description":"This action retrieve the reputation information for an IPv4.","Script":"from SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import unix_now, convert_unixtime_to_datetime, output_handler\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED,EXECUTION_STATE_TIMEDOUT\n\nfrom constants import (INTEGRATION_NAME, GET_ASN_REPUTATION_SCRIPT_NAME )\nfrom SilentPushManager import SilentPushManager\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = GET_ASN_REPUTATION_SCRIPT_NAME \n\n    # Extract Integration config\n    server_url = siemplify.extract_configuration_param(INTEGRATION_NAME, \"Silent Push Server\")\n    api_key = siemplify.extract_configuration_param(INTEGRATION_NAME, \"API Key\")\n\n    asn = siemplify.extract_action_param(\"asn\", print_value=True)\n    explain = siemplify.extract_action_param(\"explain\", print_value=True)\n    limit = siemplify.extract_action_param(\"limit\", print_value=True)\n\n    try:\n        sp_manager = SilentPushManager(server_url, api_key, logger=siemplify.LOGGER)\n        raw_response = sp_manager.get_asn_reputation(asn, limit, explain)\n        \n        asn_reputation = extract_and_sort_asn_reputation(raw_response)\n        \n        if not asn_reputation:\n            error_message = f\"No reputation data found for ASN {asn}.\"\n            siemplify.LOGGER.error(error_message)\n            status = EXECUTION_STATE_FAILED\n            siemplify.end(error_message, \"false\", status)\n        \n        status = EXECUTION_STATE_COMPLETED\n        result_value = True\n        data_for_table = prepare_asn_reputation_table(asn_reputation, explain)\n        siemplify.result.add_result_json({\"ASN\": data_for_table})\n        output_message = f\"asn : {data_for_table}\"\n    except Exception as error:\n        result_value = False\n        status = EXECUTION_STATE_FAILED\n        output_message = f\"Failed to retrieve reputation data found for ASN {asn} for {INTEGRATION_NAME} server! Error: {error}\"\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(error)\n\n\n    for entity in siemplify.target_entities:\n        print(entity.identifier)\n\n    siemplify.LOGGER.info(\"\\n  status: {}\\n  result_value: {}\\n  output_message: {}\".format(status,result_value, output_message))\n    siemplify.end(output_message, result_value, status)\n\ndef prepare_asn_reputation_table(asn_reputation: list, explain: bool) -> list:\n    \"\"\"\n    Prepare the data for the ASN reputation table.\n\n    Args:\n        asn_reputation (list): List of ASN reputation entries.\n        explain (bool): Whether to include explanations in the table.\n\n    Returns:\n        list: Data formatted for the table.\n    \"\"\"\n    data_for_table = []\n    \n    for entry in asn_reputation:\n        row = {\n            \"ASN\": entry.get(\"asn\"),\n            \"Reputation\": entry.get(\"asn_reputation\"),\n            \"ASName\": entry.get(\"asname\"),\n            \"Date\": entry.get(\"date\"),\n        }\n        if explain and entry.get(\"asn_reputation_explain\") :\n            print(\"On line 73\", explain)\n            row[\"Explanation\"] = entry.get(\"asn_reputation_explain\")\n        data_for_table.append(row)\n    return data_for_table\n\ndef extract_and_sort_asn_reputation(raw_response: dict) -> list:\n    \"\"\"\n    Extract ASN reputation data and sort by date.\n\n    Args:\n        raw_response (dict): Raw response data from API.\n\n    Returns:\n        list: Sorted ASN reputation data.\n    \"\"\"\n    response_data = raw_response.get(\"response\", {})\n\n    if not isinstance(response_data, dict):\n        response_data = {\"asn_reputation\": response_data}\n\n    asn_reputation = response_data.get(\"asn_reputation\") or response_data.get(\"asn_reputation_history\", [])\n\n    if isinstance(asn_reputation, dict):\n        asn_reputation = [asn_reputation]\n    elif not isinstance(asn_reputation, list):\n        asn_reputation = []\n\n    return sorted(asn_reputation, key=lambda x: x.get(\"date\", \"\"), reverse=True)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"Silent Push","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{}","ShowResult":false}],"Creator":"dc26f847-d850-429c-bc2c-59631a988301","IsEnabled":true,"IsCustom":true,"IsSystem":false,"Version":7.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"12345","Description":"The ASN to lookup.","Name":"asn","Value":"12345","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"false","Description":"Show the information used to calculate the reputation score.","Name":"explain","Value":"false","Type":1,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"The maximum number of reputation history records to retrieve.","Name":"limit","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","SimulationData":{"Entities":null},"SimulationDataJson":null}