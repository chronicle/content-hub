{"Name":"List IP Information","Description":"This action get IP information for multiple IPv4s and IPv6s","Script":"import ipaddress\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import unix_now, convert_unixtime_to_datetime, output_handler\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED,EXECUTION_STATE_TIMEDOUT\n\nfrom constants import (INTEGRATION_NAME, LIST_IP_INFORMATION_SCRIPT_NAME )\nfrom SilentPushManager import SilentPushManager\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = LIST_IP_INFORMATION_SCRIPT_NAME \n\n    # Extract Integration config\n    server_url = siemplify.extract_configuration_param(INTEGRATION_NAME, \"Silent Push Server\")\n    api_key = siemplify.extract_configuration_param(INTEGRATION_NAME, \"API Key\")\n\n    ips = siemplify.extract_action_param(\"ips\", print_value=True)\n    ips = ips.split(\",\")\n    \n    try:\n        sp_manager = SilentPushManager(server_url, api_key, logger=siemplify.LOGGER)\n        ipv4_addresses, ipv6_addresses = validate_ips(ips, sp_manager)\n        \n        results = []\n        if ipv4_addresses:\n            results.extend(gather_ip_information(sp_manager, ipv4_addresses, resource=\"ipv4\"))\n\n        if ipv6_addresses:\n            results.extend(gather_ip_information(sp_manager, ipv6_addresses, resource=\"ipv6\"))\n        \n        if not results:\n            error_message = f\"No information found for IPs: {', '.join(ips)}\"\n            siemplify.LOGGER.error(error_message)\n            status = EXECUTION_STATE_FAILED\n            siemplify.end(error_message, \"false\", status)\n            \n\n        output_message = f\"Comprehensive IP Information : {results}\"\n        status = EXECUTION_STATE_COMPLETED\n        result_value = True\n    except Exception as error:\n        result_value = False\n        status = EXECUTION_STATE_FAILED\n        output_message = f\"Failed to retrieve Comprehensive IP Information of IP's :{ips} for {INTEGRATION_NAME} server! Error: {error}\"\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(error)\n\n\n    for entity in siemplify.target_entities:\n        print(entity.identifier)\n\n    siemplify.LOGGER.info(\"\\n  status: {}\\n  result_value: {}\\n  output_message: {}\".format(status,result_value, output_message))\n    siemplify.end(output_message, result_value, status)\n\ndef validate_ip_address(self, ip: str, allow_ipv6: bool = True) -> bool:\n        \"\"\"\n        Validate an IP address.\n\n        Args:\n            self: The instance of the class.\n            ip (str): IP address to validate.\n            allow_ipv6 (bool, optional): Whether to allow IPv6 addresses. Defaults to True.\n\n        Returns:\n            bool: True if valid IP address, False otherwise.\n        \"\"\"\n        try:\n            ip = ip.strip()\n            ip_obj = ipaddress.ip_address(ip)\n\n            return not (not allow_ipv6 and ip_obj.version == 6)\n        except ValueError:\n            return False\n        \ndef validate_ips(ips: list, client: SilentPushManager) -> tuple:\n    \"\"\"\n    Validates and categorizes the IPs into IPv4 and IPv6 addresses.\n\n    Args:\n        ips (list): List of IPs to validate.\n        client (SilentPushManager): The client instance to use for validation.\n\n    Returns:\n        tuple: A tuple containing two lists: (ipv4_addresses, ipv6_addresses)\n    \"\"\"\n    ipv4_addresses = []\n    ipv6_addresses = []\n\n    for ip in ips:\n        if client.validate_ip_address(ip, allow_ipv6=False):  # IPv4\n            ipv4_addresses.append(ip)\n        elif client.validate_ip_address(ip, allow_ipv6=True):  # IPv6\n            ipv6_addresses.append(ip)\n\n    return ipv4_addresses, ipv6_addresses\n\n\ndef gather_ip_information(client: SilentPushManager, ip_addresses: list, resource: str) -> list:\n    \"\"\"\n    Gathers IP information for a given list of IP addresses.\n\n    Args:\n        client (SilentPushManager): The client instance to query IP information.\n        ip_addresses (list): The list of IPs to gather information for.\n        resource (str): The resource type ('ipv4' or 'ipv6').\n\n    Returns:\n        list: A list of IP to ASN information.\n    \"\"\"\n    ip_info = client.list_ip_information(ip_addresses, resource=resource)\n    return ip_info.get(\"response\", {}).get(\"ip2asn\", [])\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"Silent Push","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{}","ShowResult":false}],"Creator":"dc26f847-d850-429c-bc2c-59631a988301","IsEnabled":true,"IsCustom":true,"IsSystem":false,"Version":3.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"142.251.188.102","Description":"Comma-separated list of IP addresses.","Name":"ips","Value":"142.251.188.102","Type":0,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","SimulationData":{"Entities":null},"SimulationDataJson":null}