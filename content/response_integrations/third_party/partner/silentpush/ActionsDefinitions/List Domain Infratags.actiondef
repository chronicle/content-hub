{"Name":"List Domain Infratags","Description":"This action get infratags for multiple domains with optional clustering.","Script":"from SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import unix_now, convert_unixtime_to_datetime, output_handler\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED,EXECUTION_STATE_TIMEDOUT\n\nfrom constants import (INTEGRATION_NAME, LIST_DOMAIN_INFRATAGS_SCRIPT_NAME )\nfrom SilentPushManager import SilentPushManager\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = LIST_DOMAIN_INFRATAGS_SCRIPT_NAME \n\n    # Extract Integration config\n    server_url = siemplify.extract_configuration_param(INTEGRATION_NAME, \"Silent Push Server\")\n    api_key = siemplify.extract_configuration_param(INTEGRATION_NAME, \"API Key\")\n\n    domain = siemplify.extract_action_param(\"domain\", print_value=True)\n    cluster = siemplify.extract_action_param(\"cluster\", print_value=True)\n    mode = siemplify.extract_action_param(\"mode\", print_value=True)\n    arg_match = siemplify.extract_action_param(\"match\", print_value=True)\n    as_of = siemplify.extract_action_param(\"as_of\", print_value=True)\n    origin_uid = siemplify.extract_action_param(\"origin_uid\", print_value=True)\n    use_get = siemplify.extract_action_param(\"use_get\", print_value=True)\n    cluster = cluster.lower() == \"true\"\n\n    domains:list = domain.split(',')\n    if not domains and not use_get:\n        raise ValueError('\"domains\" argument is required when using POST.')\n\n    try:\n        sp_manager = SilentPushManager(server_url, api_key, logger=siemplify.LOGGER)\n        raw_response = sp_manager.list_domain_infratags(domains, cluster, mode=mode, arg_match=arg_match, as_of=as_of, origin_uid=origin_uid)\n        \n        response_mode = raw_response.get(\"response\", {}).get(\"mode\", \"\").lower()\n        if response_mode and response_mode != mode:\n            raise ValueError(f\"Expected mode '{mode}' but got '{response_mode}'\")\n\n        infratags = raw_response.get(\"response\", {}).get(\"infratags\", [])\n        tag_clusters = raw_response.get(\"response\", {}).get(\"tag_clusters\", [])\n        \n        if not infratags:\n            error_message = f\"No data found for domain: {domain}\"\n            siemplify.LOGGER.error(error_message)\n            status = EXECUTION_STATE_FAILED\n            siemplify.end(error_message, \"false\", status)\n            \n\n        if cluster:\n            tag_clusters_res = format_tag_clusters(tag_clusters)\n            output_message = f\"infratags: {infratags}, Domain Tag Clusters: {tag_clusters_res}\"\n            siemplify.result.add_result_json({\"infratags\": infratags, \"Domain Tag Clusters\":tag_clusters_res})\n        else:\n            output_message = f\"infratags: {infratags}\"\n            siemplify.result.add_result_json({\"infratags\": infratags})\n        status = EXECUTION_STATE_COMPLETED\n        result_value = True\n        \n    except Exception as error:\n        result_value = False\n        status = EXECUTION_STATE_FAILED\n        output_message = f\"Failed to retrieve data of domain :{domain} for {INTEGRATION_NAME} server! Error: {error}\"\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(error)\n\n    for entity in siemplify.target_entities:\n        print(entity.identifier)\n\n    siemplify.LOGGER.info(\"\\n  status: {}\\n  result_value: {}\\n  output_message: {}\".format(status,result_value, output_message))\n    siemplify.end(output_message, result_value, status)\n\ndef format_tag_clusters(tag_clusters: list):\n    \"\"\"\n    Helper function to format the tag clusters output.\n\n    Args:\n        tag_clusters (list): List of domain tag clusters.\n\n    Returns:\n        str: Formatted table output for tag clusters.\n    \"\"\"\n    if not tag_clusters:\n        return \"\\n\\n**No tag cluster data returned by the API.**\"\n\n    cluster_details = [{\"Cluster Level\": key, \"Details\": value} for cluster in tag_clusters for key, value in cluster.items()]\n    return cluster_details\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"Silent Push","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{}","ShowResult":false}],"Creator":"dc26f847-d850-429c-bc2c-59631a988301","IsEnabled":true,"IsCustom":true,"IsSystem":false,"Version":11.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Mode for lookup (live/padns). Defaults to \"live\". Default is live.","Name":"mode","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Handling of self-hosted infrastructure. Defaults to \"self\". Default is self.","Name":"match","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Build infratags from padns data where the as_of timestamp equivalent is between the first_seen and the last_seen timestamp.","Name":"as_of","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"true","Description":"use","Name":"use_get","Value":"true","Type":1,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"origin_uid","Name":"origin_uid","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"silentpush.com","Description":"Comma-separated list of domains.","Name":"domain","Value":"silentpush.com","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"false","Description":"Whether to cluster the results.","Name":"cluster","Value":"false","Type":1,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","SimulationData":{"Entities":null},"SimulationDataJson":null}