{"Name":"Get Domain Certificates","Description":"This action get certificate data collected from domain scanning.","Script":"from SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import unix_now, convert_unixtime_to_datetime, output_handler\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED,EXECUTION_STATE_TIMEDOUT\n\n\nfrom constants import (INTEGRATION_NAME, GET_DOMAIN_CERTIFICATES_SCRIPT_NAME )\nfrom SilentPushManager import SilentPushManager\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = GET_DOMAIN_CERTIFICATES_SCRIPT_NAME \n\n    # Extract Integration config\n    server_url = siemplify.extract_configuration_param(INTEGRATION_NAME, \"Silent Push Server\")\n    api_key = siemplify.extract_configuration_param(INTEGRATION_NAME, \"API Key\")\n\n    domain = siemplify.extract_action_param(\"domain\", print_value=True)\n    domain_regex = siemplify.extract_action_param(\"domain_regex\", print_value=True)\n    certificate_issuer = siemplify.extract_action_param(\"certificate_issuer\", print_value=True)\n    date_min = siemplify.extract_action_param(\"date_min\", print_value=True)\n    date_max = siemplify.extract_action_param(\"date_max\", print_value=True)\n    prefer = siemplify.extract_action_param(\"prefer\", print_value=True)\n    max_wait = siemplify.extract_action_param(\"max_wait\", print_value=True)\n    with_metadata = siemplify.extract_action_param(\"with_metadata\", print_value=True)\n    skip = siemplify.extract_action_param(\"skip\", print_value=True)\n    limit = siemplify.extract_action_param(\"limit\", print_value=True)\n\n    params = {\n        \"domain_regex\": domain_regex,\n        \"cert_issuer\": certificate_issuer,\n        \"date_min\": date_min,\n        \"date_max\": date_max,\n        \"prefer\": prefer,\n        \"max_wait\": int(max_wait) if max_wait else None,\n        \"with_metadata\":  bool(with_metadata) if with_metadata else False,\n        \"skip\":  int(skip) if skip else None,\n        \"limit\": int(limit) if limit else None,\n    }\n    filter_params = {key:value for key, value in params.items() if value is not None}\n\n    try:\n        sp_manager = SilentPushManager(server_url, api_key, logger=siemplify.LOGGER)\n        raw_response = sp_manager.get_domain_certificates(domain, **(filter_params or {}))\n        \n        if raw_response.get(\"response\", {}).get(\"job_status\", {}):\n            job_details = raw_response.get(\"response\", {}).get(\"job_status\", {})\n            \n            output_message = f\"domain: {domain}, job_details: {job_details}\"\n            status = EXECUTION_STATE_COMPLETED\n            result_value = True\n            \n            siemplify.end(output_message, result_value, status)\n       \n        certificates = raw_response.get(\"response\", {}).get(\"domain_certificates\", [])\n        metadata = raw_response.get(\"response\", {}).get(\"metadata\", {})\n\n        if not certificates:\n            error_message = f\"No certificates found for domain: {domain}\"\n            siemplify.LOGGER.error(error_message)\n            status = EXECUTION_STATE_FAILED\n            siemplify.end(error_message, \"false\", status)    \n        \n        output_message = f\"domain: {domain}, certificates: {certificates}, metadata: {metadata}\"\n        status = EXECUTION_STATE_COMPLETED\n        result_value = True\n    except Exception as error:\n        result_value = False\n        status = EXECUTION_STATE_FAILED\n        output_message = f\"Failed to retrieve certificates data for domain {domain} for {INTEGRATION_NAME} server! Error: {error}\"\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(error)\n\n    for entity in siemplify.target_entities:\n        print(entity.identifier)\n\n    siemplify.LOGGER.info(\"\\n  status: {}\\n  result_value: {}\\n  output_message: {}\".format(status,result_value, output_message))\n    siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"Silent Push","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{}","ShowResult":false}],"Creator":"dc26f847-d850-429c-bc2c-59631a988301","IsEnabled":true,"IsCustom":true,"IsSystem":false,"Version":4.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"silentpush.com","Description":"The domain to query certificates for.","Name":"domain","Value":"silentpush.com","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Regular expression to match domains.","Name":"domain_regex","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Filter by certificate issuer.","Name":"certificate_issuer","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Filter certificates issued on or after this date.","Name":"date_min","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Filter certificates issued on or before this date.","Name":"date_max","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Prefer to wait for results for longer running queries or to return job_id immediately (Defaults to Silent Push API behaviour).","Name":"prefer","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Number of seconds to wait for results before returning a job_id, with a range from 0 to 25 seconds.","Name":"max_wait","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Includes a metadata object in the response, containing returned results, total results, and job_id.","Name":"with_metadata","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Number of results to skip.","Name":"skip","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":null,"Description":"Number of results to return.","Name":"limit","Value":null,"Type":0,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","SimulationData":{"Entities":null},"SimulationDataJson":null}