<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i"
    rel="stylesheet">
  <link
    href='https://fonts.googleapis.com/css?family=Source Sans Pro'
    rel='stylesheet'>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <title>Query Widget</title>
  <style>
      :root {
          --dark-gray-100: hsl(0, 0%, 1000%);
          --dark-gray-200: hsl(216, 45%, 84%);
          --dark-gray-300: hsl(220, 22%, 62%);
          --dark-gray-400: hsl(221, 26%, 46%);
          --dark-gray-500: hsl(221, 30%, 33%);
          --dark-gray-600: hsl(221, 32%, 27%);
          --dark-gray-700: hsl(221, 35%, 23%);
          --dark-gray-800: hsl(221, 35%, 20%);
          --dark-gray-900: hsl(240, 25%, 12%);

          --color-table-even-row: hsl(226, 32%, 15%);
          --color-link: hsl(217, 89%, 76%);

          --widget-width-in-screen: 100%;
          --widget-height-in-screen: 100%;

          --widget-font-style: normal;

          --widget-text-font: 'Source Sans Pro', sans-serif;
          --widget-number-font: 'Open Sans', sans-serif;

          --font-weight-bold: 700;
          --font-weight-semibold: 600;
          --font-weight-regular: 400;

          --font-size-big: 16px;
          --font-size-medium: 14px;

          --default-line-height: 16px;

          --scrollbar-size: 12px;
      }

      html {
          height: var(--widget-height-in-screen);
          width: var(--widget-width-in-screen);
      }

      body {
          background-color: var(--dark-gray-800);

          height: var(--widget-height-in-screen);
          width: var(--widget-width-in-screen);

          padding: 0;
          margin: 0;

          overflow: hidden;
      }

      .logo {
          padding-bottom: 8px;
          padding-top: 8px;
          width: 64px;
          float: right;
      }


      .main-counter {
          font-style: var(--widget-font-style);

          padding: 12px 4% 12px 4%;

          justify-content: center;
          clear: both;
      }

      .counter {
          font-weight: var(--font-weight-bold);
          font-family: var(--widget-number-font);

          color: var(--dark-gray-100);

          font-size: 64px;
          line-height: 0;

          align-items: center;
          text-align: center;
      }

      .counter-title {
          font-weight: var(--font-weight-semibold);
          font-family: var(--widget-text-font);

          color: var(--dark-gray-100);

          font-size: 20px;

          text-transform: uppercase;
          text-align: center;
      }

      .main-table {
          font-family: var(--widget-text-font);
          font-style: var(--widget-font-style);

          line-height: var(--default-line-height);

          color: var(--dark-gray-100);

          overflow-x: scroll;
      }

      .main-table table {
          font-size: var(--font-size-medium);

          width: 100%;

          border-collapse: collapse;
          word-break: keep-all;
      }

      .main-table th {
          font-weight: var(--font-weight-semibold);
          line-height: var(--default-line-height);

          background-color: var(--dark-gray-600);

          padding: 8px 16px;

          text-transform: uppercase;
          vertical-align: top;
          text-align: left;
          white-space: nowrap;
      }

      .main-table tr {
          font-weight: var(--font-weight-regular);
      }

      .main-table tr:nth-child(even) {
          background-color: var(--color-table-even-row);
      }

      .main-table td {
          padding: 8px 16px;

          vertical-align: top;
          white-space: pre-wrap;
          word-wrap: break-word;
      }

      p.long-text {
          margin-top: 0;
          margin-bottom: 0;
          white-space: pre-wrap;
          word-wrap: break-word;
          max-width: 500px;
      }

      .long-text .hidden-content {
          visibility: hidden;
          overflow: hidden;
          max-height: 0;
          float: left;
      }

      .card-container {
          height: var(--widget-height-in-screen);
          width: var(--widget-width-in-screen);

          display: flex;
      }

      .right-side {
          padding: 8px 16px;
          width: 100%;
          gap: 24px;
          overflow: scroll;
      }

      .left-side {
          padding-right: 8px;
          max-width: 180px;
          min-width: 180px;
          width: 180px;
          border-right: 1px solid var(--dark-gray-400);
          overflow: scroll;
      }

      .left-menu-item {
          font-family: var(--widget-text-font);
          font-weight: var(--font-weight-regular);
          font-style: var(--widget-font-style);
          font-size: var(--font-size-medium);

          color: var(--dark-gray-200);

          padding-left: 10px;
          line-height: 38px;
          height: 38px;

          text-overflow: ellipsis;
          white-space: nowrap;
          overflow: hidden;
          cursor: pointer;
          display: block;
      }

      .left-menu-item.active {
          background: var(--dark-gray-500);

          font-weight: var(--font-weight-semibold);
          font-size: var(--font-size-medium);

          color: var(--dark-gray-100);
      }

      .top-title {
          font-family: var(--widget-text-font);

          color: var(--dark-gray-100);

          border-bottom: 1px solid var(--dark-gray-400);
          margin-bottom: 4px;

          justify-content: space-between;
          align-items: center;
          display: flex;
      }

      .top-title-display-value {
          font-weight: var(--font-weight-semibold);

          line-height: 25px;
          font-size: 20px;
          max-width: 70%;

          text-overflow: ellipsis;
          overflow: hidden;
      }

      ::-webkit-scrollbar {
          width: var(--scrollbar-size);
          height: var(--scrollbar-size);
      }

      ::-webkit-scrollbar-thumb {
          border-radius: 10px;
          border: 3px solid transparent;
          background: var(--dark-gray-400);
          background-clip: content-box;
      }

      ::-webkit-scrollbar-track {
          background-color: transparent;
      }

      ::-webkit-scrollbar-corner {
          background-color: transparent;
      }

      .link {
          color: var(--color-link);

          font-family: var(--widget-text-font);
          font-weight: var(--font-weight-regular);
          font-style: var(--widget-font-style);
          font-size: var(--font-size-medium);

          line-height: var(--default-line-height);

          text-decoration-line: underline;
          align-items: center;
      }
  </style>
</head>
<body>
<div class="card-container">
  <div class="left-side" id="left-menu"></div>
  <div class="right-side" id="right-menu">
    <div class="top-title">
      <div class="top-title-display-value" id="title-display-value"></div>
      <svg class="logo" fill="none" height="25" viewBox="0 0 92 25" width="92"
           xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0 25H5.41176L8.38824 9.73684L14.3412 25H18.1294L24.0824 9.73684L27.3294 25H32.7412L27.3294 0H22.7294L16.2353 15.2632L10.0118 0H4.87059L0 25Z"
          fill="white"/>
        <path d="M38.6941 25V0H34.0941V25H38.6941Z" fill="white"/>
        <path d="M40.3176 3.94737V0H56.2824V3.94737H50.6V25H45.7294V3.94737H40.3176Z" fill="white"/>
        <path
          d="M57.3647 0V25H62.2353V4.21053H68.1882C69.0902 4.12281 70.8941 4.57895 70.8941 7.10526C70.8941 9.63158 69.0902 10.0877 68.1882 10H63.0471V14.4737L70.8941 25H76.8471L68.1882 14.4737C74.4118 14.4737 76.0353 10 76.0353 7.10526C76.0353 1.57895 72.2471 0 69.5412 0H57.3647Z"
          fill="white"
        />
        <path
          d="M77.6588 0V25H92V21.0526H82.2588V14.4737H92V10.5263H82.2588V10.2632V3.94737H92V0H77.6588Z"
          fill="white"/>
      </svg>
    </div>
    <div class="main-counter">
      <h1 class="counter" id="counter"></h1>
      <h2 class="counter-title" id="counter-title"></h2>
    </div>
    <div class="main-table">
      <table id="main-table">
        <thead>
        <tr>
          <th id="External ID" style="width: 25%;">
            External ID
          </th>
          <th id="Mitigation" style="width: 30%;">
            Mitigation
          </th>
          <th id="Description">
            Description
          </th>
        </tr>
        </thead>
        <tbody id="main-table-body"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
    $(document).ready(() => {
        if ($("body").css("background-color") === "rgb(255, 255, 255)") {
            $(".logo svg path").attr("fill", "black");
        } else {
            $(".logo svg path").attr("fill", "white");
        }

        const actionListData = [{stepInstanceName}.JsonResult];
        if (!actionListData.length) {
            return;
        }

        entityDisplayed(actionListData[0]);

        createLeftMenu();

        $(".left-side").click(event => {
            const arrayLeftSide = $(".left-menu-item");
            const id = event.target.id;

            $.each(arrayLeftSide, (key, value) => {
                if (value.id === id) {
                    $(`#${value.id}`).addClass("active");
                } else {
                    $(`#${value.id}`).removeClass("active");
                }
            });

            const object = actionListData.find(el => {
                if (el.Entity) {
                    return removeSpecialSymbols(el.Entity) === id.split("--__split__--")[0];
                }
            });

            entityDisplayed(object);

            $("#right-menu").scrollTop(0);
        });

        function entityDisplayed(el) {
            const dataCount = el.EntityResult.mitigations.length;
            if (dataCount === 1) {
                $("#counter-title").html("MITIGATION");
            } else {
                $("#counter-title").html("MITIGATIONS");
            }

            $("#counter").html(dataCount);
            $("#title-display-value").html(el.Entity);

            const iterListData = el.EntityResult.mitigations;
            let mhtml = "";
            $.each(iterListData, (key, el) => {
                mhtml += "<tr>";

                mhtml += "<td>" + createTitleId(el) + "</td>";

                mhtml += "<td>" +
                    fieldExists(el.name)
                    + "</td>";

                mhtml += "<td>" +
                    getCollapsableEscapedHTML(
                        fieldExists(el.description),
                    )
                    + "</td>";

                mhtml += "</tr>";
            });

            $("#main-table-body").html(mhtml);

            /* Toggle off a column if all the values in it are "N/A" */
            $("th").each(function (idx, _) {
                const check = Boolean(
                    $("tbody tr").find("td:eq(" + idx + ")").filter(function () {
                        return ["N/A", ""].includes($.trim($(this).text())) ? 0 : 1;
                    }).length,
                );

                $("tr").find("td:eq(" + idx + "), th:eq(" + idx + ")").toggle(check);
            });

            function fieldExists(field, toFormatData = true) {
                if (toFormatData) {
                    field = formatData(field);
                }
                return [undefined, ""].includes(field) ? "N/A" : field;
            }

            function formatData(data) {
                const isObject = obj => obj && obj.constructor === ({}).constructor;
                const formatIfObject = item => isObject(item) ? JSON.stringify(item, null, 4) : item;

                if (Array.isArray(data)) {
                    return data.map(
                        item => Array.isArray(item) ? formatData(item) : formatIfObject(item),
                    ).join(",\n");
                }

                return formatIfObject(data);
            }

            addLongTextClickLogic();

            function getCollapsableEscapedHTML(text, maxCharsLimit = 250) {
                if (!text) {
                    return text;
                }

                if (text.length < maxCharsLimit) {
                    return `<p class="long-text">${escapeHTML(text)}</p>`;
                }

                text = escapeHTML(text);
                let firstPart = text.slice(0, maxCharsLimit);
                let secondPart = text.slice(maxCharsLimit);

                const lastSpaceIndex = firstPart.lastIndexOf(" ");
                const spaceSearchPercentage = 0.6;
                const newMaxWithSpace = maxCharsLimit * spaceSearchPercentage;
                if (lastSpaceIndex >= newMaxWithSpace) {
                    firstPart = text.slice(0, lastSpaceIndex);
                    secondPart = text.slice(lastSpaceIndex);
                }

                return `<p class="long-text">` +
                    `${firstPart}<span>... </span>` +
                    `<br><a href="#" class="more link">Show more</a>` +
                    `<span class="hidden-content">` +
                    `${secondPart}` +
                    `<br><a href="#" class="less link">Show less</a>` +
                    `</span>` +
                    `</p>`;
            }

            function addLongTextClickLogic() {
                $(".more").click(function (event) {
                    event.preventDefault();
                    $(this).hide()
                        .prev().hide()
                        .prev().hide();

                    $(this).next().toggleClass("hidden-content");
                });

                $(".less").click(function (event) {
                    event.preventDefault();
                    $(this).parent().toggleClass("hidden-content")
                        .prev().show()
                        .prev().show()
                        .prev().show();
                });
            }

            function escapeHTML(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

        }

        function createLeftMenu() {
            if (actionListData.length == 1) {
                $("#left-menu").hide();
            }
            let string = "";
            actionListData.forEach((el, index) => {
                const displayValue = el.Entity;
                const cleanDisplayValue = removeSpecialSymbols(displayValue) +
                    "--__split__--" +
                    Math.floor(Math.random() * 1_000_000_000_000_000);

                index ?
                    string += `<div class="left-menu-item" id="${cleanDisplayValue}">${displayValue}</div>` :
                    string += `<div class="left-menu-item active" id="${cleanDisplayValue}">${displayValue}</div>`;
            });

            $("#left-menu").html(string);
        }

        function removeSpecialSymbols(el) {
            return el.replaceAll(/[\s ;:.,/%!&?-]/g, "").replaceAll("\\", "");
        }

        function createTitleId(entity) {
            const external_references = entity.external_references;
            if (!external_references || external_references.length === 0) return "N/A";

            return external_references.map(ref => {
                const externalId = ref.external_id || "N/A";
                const url = ref.url ? `<a href="${ref.url}" target="_blank" class="link">${externalId}</a>` : externalId;
                return url;
            }).join(", ");
        }

    });
</script>
</body>
</html>
