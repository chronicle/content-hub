filter {
  mutate {
    replace => {
      "event_data" => ""
      "productlogid" => ""
      "kv_msg" => ""
      "msg" => ""
      "deviceCustomDate1" => ""
      "rt" => ""
    }
  }

  grok {
    match => {
      "message" => [
        "%{GREEDYDATA:event_data} \\| %{GREEDYDATA:kv_msg}"
      ]
    }
    overwrite => ["event_data" ,"msg" ,"kv_msg"]
    on_error => "grok_failure"
  }

  mutate {
    gsub => ["kv_msg", " ([a-zA-Z0-9]+=)","#$1"]
  }

  kv {
    source => "kv_msg"
    field_split => "#"
    value_split => "="
    on_error => "kv_failure"
  }

  mutate {
    replace => {
      "event_type" => "GENERIC_EVENT"
    }
  }

  if [msg] != "" {
    mutate {
      replace => {
        "msg_label.value.string_value" => "%{msg}"
      }
      on_error => "msg_empty"
    }
    if ![msg_empty] {
      mutate {
        replace => {
          "msg_label.key" => "msg"
        }
      }
      mutate {
        merge => {
          "event.idm.read_only_udm.additional.fields" => "msg_label"
        }
        on_error => "msg_label_empty"
      }
    }
  }

  if [event_data] != "" {
    mutate {
      replace => {
        "event.idm.read_only_udm.metadata.description" => "%{event_data}"
      }
      on_error => "event_data_empty"
    }
  }

  mutate {
    rename => {
      "event_type" => "event.idm.read_only_udm.metadata.event_type"
    }
  }

  mutate {
    merge => {
      "@output" => "event"
    }
  }
}
